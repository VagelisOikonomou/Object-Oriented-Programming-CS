@page "/products"
@rendermode InteractiveServer
@using MiniEshopBlazor.Models
@inject MiniEshopBlazor.Services.ProductService ProductService

<h3 class="page-title">Όλα τα Προϊόντα</h3>

@if (products == null)
{
    <p class="text-muted2">Φόρτωση προϊόντων...</p>
}
else
{
    <div class="admin-filters" style="margin-bottom:12px;">
        <input class="auth-input admin-search"
               type="search"
               placeholder="Αναζήτηση (όνομα/κατηγορία)..."
               value="@search"
               @oninput="OnSearchChanged" />

        <select class="auth-input admin-select" @bind="sortMode">
            <option value="name_asc">Όνομα (A–Z)</option>
            <option value="name_desc">Όνομα (Z–A)</option>
            <option value="price_asc">Τιμή (αύξουσα)</option>
            <option value="price_desc">Τιμή (φθίνουσα)</option>
            <option value="stock_desc">Απόθεμα (περισσότερο)</option>
            <option value="stock_asc">Απόθεμα (λιγότερο)</option>
        </select>

        <div style="display:flex; align-items:center; justify-content:flex-end;">
            <button class="btn btn-secondary" @onclick="ClearSearch" type="button">Clear</button>
        </div>
    </div>

    <div class="text-muted2" style="margin-bottom:10px;">
        Εμφανίζονται: <strong>@FilteredAndSorted.Count()</strong> προϊόντα
    </div>

    @if (!FilteredAndSorted.Any())
    {
        <div class="panel">
            <p class="text-muted2" style="margin:0;">Δεν βρέθηκαν προϊόντα.</p>
        </div>
    }
    else
    {
        <div class="product-grid">
            @foreach (var product in FilteredAndSorted)
            {
                <div class="card-x">
                    <div class="card-x-body">
                        <div class="card-x-title">@product.Name</div>
                        <div class="card-x-desc">@product.Description</div>

                        <div class="product-card-bottom">
                            <div class="product-card-left">
                                <span class="price">@product.Price €</span>
                            </div>

                            <div class="product-card-right">
                                <img class="product-thumb"
                                     src="@(string.IsNullOrWhiteSpace(product.ImageUrl)
                                                         ? "/images/products/placeholder.jpg"
                                                         : product.ImageUrl)"
                                     alt="@product.Name" />

                                @if (product.Stock > 0)
                                {
                                    <span class="badge success">In stock: @product.Stock</span>
                                }
                                else
                                {
                                    <span class="badge danger">Out of stock</span>
                                }
                            </div>
                        </div>


                        <a class="btn btn-primary w-100" href="/product/@product.Id">Λεπτομέρειες</a>
                    </div>
                </div>
            }
        </div>
    }
}

@code {
    private List<Product> products;
    private string search = string.Empty;

    // default sorting
    private string sortMode = "name_asc";

    protected override async Task OnInitializedAsync()
    {
        products = await ProductService.GetAsync();
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        search = e?.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }

    private void ClearSearch()
    {
        search = string.Empty;
        StateHasChanged();
    }

    private IEnumerable<Product> FilteredAndSorted
    {
        get
        {
            if (products == null) return Enumerable.Empty<Product>();

            // 1) Filter
            IEnumerable<Product> query = products;

            var s = (search ?? "").Trim().ToLowerInvariant();
            if (!string.IsNullOrEmpty(s))
            {
                query = query.Where(p =>
                    (p.Name ?? "").ToLowerInvariant().Contains(s) ||
                    (p.Category ?? "").ToLowerInvariant().Contains(s));
            }

            // 2) Sort
            query = sortMode switch
            {
                "name_desc" => query.OrderByDescending(p => p.Name),
                "price_asc" => query.OrderBy(p => p.Price).ThenBy(p => p.Name),
                "price_desc" => query.OrderByDescending(p => p.Price).ThenBy(p => p.Name),
                "stock_asc" => query.OrderBy(p => p.Stock).ThenBy(p => p.Name),
                "stock_desc" => query.OrderByDescending(p => p.Stock).ThenBy(p => p.Name),
                _ => query.OrderBy(p => p.Name) // name_asc
            };

            return query;
        }
    }
}
