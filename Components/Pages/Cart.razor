@page "/cart"
@rendermode InteractiveServer
@inject MiniEshopBlazor.Services.CartService CartService
@inject NavigationManager Navigation

<h3 class="page-title">Καλάθι Αγορών</h3>

@if (!CartService.Items.Any())
{
    <div class="cart-card">
        <p class="text-muted2">Το καλάθι είναι άδειο.</p>
        <button class="btn btn-secondary" @onclick="GoToProducts">Πίσω στα προϊόντα</button>
    </div>
}
else
{
    <div class="cart-grid">
        <div class="cart-card">
            <div class="cart-head">
                <div>
                    <div class="page-title" style="margin:0;">Προϊόντα</div>
                    <div class="cart-sub">@CartService.Items.Sum(i => i.Quantity) τεμάχια στο καλάθι</div>
                </div>

                <button class="btn btn-secondary" @onclick="GoToProducts">+ Συνέχεια αγορών</button>
            </div>

            @foreach (var item in CartService.Items)
            {
                <div class="cart-item">
                    <div class="cart-thumb">
                        @GetInitials(item.Product.Name)
                    </div>

                    <div>
                        <div class="cart-name">@item.Product.Name</div>
                        <div class="cart-meta">@item.Product.Category</div>
                        <div class="cart-meta">@item.Product.Price € / τεμ.</div>
                    </div>

                    <div class="cart-actions">
                        <div class="qty">
                            <button class="icon-btn" title="Μείωση" @onclick="() => RemoveOne(item.Product.Id)">−</button>
                            <span class="qnum">@item.Quantity</span>
                            <button class="icon-btn" title="Αύξηση" @onclick="() => AddOne(item.Product.Id)">+</button>
                        </div>

                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => RemoveAll(item.Product.Id)">
                                Αφαίρεση
                            </button>
                        </div>
                    </div>

                    <div class="cart-pricing">
                        <div class="cart-meta">Σύνολο</div>
                        <div class="cart-lineprice">@LineTotal(item) €</div>
                    </div>
                </div>
            }
        </div>

        <div class="cart-card">
            <div class="page-title" style="margin:0 0 10px 0;">Σύνοψη Παραγγελίας</div>

            <div class="summary-row">
                <span class="text-muted2">Υποσύνολο</span>
                <strong>@CartService.Total() €</strong>
            </div>

            <div class="summary-row">
                <span class="text-muted2">Μεταφορικά</span>
                <strong>0 €</strong>
            </div>

            <div class="summary-row">
                <span class="text-muted2">Έκπτωση</span>
                <strong>0 €</strong>
            </div>

            <div class="summary-row" style="padding-top:12px;">
                <span class="summary-total">Τελικό</span>
                <span class="summary-total">@CartService.Total() €</span>
            </div>

            <button class="btn btn-danger full-width" @onclick="ClearCart">Καθαρισμός καλαθιού</button>
        </div>
    </div>
}

@code {
    private void AddOne(string id)
    {
        var product = CartService.Items.First(i => i.Product.Id == id).Product;
        CartService.Add(product);
    }

    private void RemoveOne(string id) => CartService.RemoveOne(id);
    private void RemoveAll(string id) => CartService.RemoveAll(id);
    private void ClearCart() => CartService.Clear();
    private void GoToProducts() => Navigation.NavigateTo("/products");

    private static decimal LineTotal(MiniEshopBlazor.Models.CartItem item)
        => item.Product.Price * item.Quantity;

    private static string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0].Substring(0, 1).ToUpper();
        return (parts[0].Substring(0, 1) + parts[1].Substring(0, 1)).ToUpper();
    }
}
