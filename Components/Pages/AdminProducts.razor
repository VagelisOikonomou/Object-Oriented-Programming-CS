@page "/admin/products"
@rendermode InteractiveServer
@using MiniEshopBlazor.Models
@inject MiniEshopBlazor.Services.AuthService AuthService
@inject MiniEshopBlazor.Services.ProductService ProductService
@inject NavigationManager Navigation

@if (!AuthService.IsLoggedIn)
{
    <div class="panel">
        <p class="text-muted2">Δεν έχετε πρόσβαση. Μεταφορά στη σελίδα login...</p>
    </div>
}
else
{
    <div class="admin-shell">

        <div class="admin-head">
            <div>
                <h3 class="page-title" style="margin:0;">Διαχείριση Προϊόντων</h3>
            </div>

            <div class="admin-actions">
                <button class="btn btn-success" @onclick="GoToAdd">+ Νέο Προϊόν</button>
                <button class="btn btn-secondary" @onclick="Refresh">Ανανέωση</button>
            </div>
        </div>

        <div class="admin-stats">
            <div class="card-x">
                <div class="card-x-body">
                    <div class="stat-k">Σύνολο προϊόντων</div>
                    <div class="stat-v">@TotalProducts</div>
                </div>
            </div>

            <div class="card-x">
                <div class="card-x-body">
                    <div class="stat-k">Σε απόθεμα</div>
                    <div class="stat-v">@InStockCount</div>
                </div>
            </div>

            <div class="card-x">
                <div class="card-x-body">
                    <div class="stat-k">Out of stock</div>
                    <div class="stat-v">@OutOfStockCount</div>
                </div>
            </div>
        </div>

        <div class="card-x">
            <div class="card-x-body">
                <div class="admin-filters">
                    <input class="auth-input admin-search"
                           placeholder="Αναζήτηση (όνομα/κατηγορία)..."
                           @bind="search"
                           @bind:event="oninput" />

                    <select class="auth-input admin-select" @bind="stockFilter">
                        <option value="all">Όλα</option>
                        <option value="instock">Σε απόθεμα</option>
                        <option value="out">Out of stock</option>
                    </select>
                </div>

                @if (products == null)
                {
                    <p class="text-muted2" style="margin:0;">Φόρτωση...</p>
                }
                else if (!FilteredProducts.Any())
                {
                    <div class="panel" style="margin-top:12px;">
                        <p class="text-muted2" style="margin:0;">Δεν βρέθηκαν προϊόντα.</p>
                    </div>
                }
                else
                {
                    <div class="admin-list">
                        @foreach (var p in FilteredProducts)
                        {
                            <div class="admin-row">
                                <div class="admin-main">
                                    <div class="admin-name">@p.Name</div>
                                    <div class="admin-meta">
                                        <span class="badge">@p.Category</span>

                                        @if (p.Stock > 0)
                                        {
                                            <span class="badge success">In stock: @p.Stock</span>
                                        }
                                        else
                                        {
                                            <span class="badge danger">Out of stock</span>
                                        }
                                    </div>
                                </div>

                                <div class="admin-price">
                                    <div class="text-muted2">Τιμή</div>
                                    <div class="price">@p.Price €</div>
                                </div>

                                <div class="admin-row-actions">
                                    <button class="icon-btn" title="Edit" @onclick="() => GoToEdit(p.Id)">✎</button>
                                    <button class="icon-btn danger2" title="Delete" @onclick="() => AskDelete(p.Id, p.Name)">🗑</button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        @if (showDeleteModal)
        {
            <div class="modal-backdrop2" @onclick="CloseDelete"></div>
            <div class="modal2">
                <div class="modal2-card card-x">
                    <div class="card-x-body">
                        <h4 style="margin:0 0 8px 0;">Διαγραφή προϊόντος</h4>
                        <p class="text-muted2" style="margin:0 0 14px 0;">
                            Θέλεις σίγουρα να διαγράψεις το <strong>@deleteName</strong>;
                        </p>

                        <div class="d-flex gap-2">
                            <button class="btn btn-danger" @onclick="ConfirmDelete">Διαγραφή</button>
                            <button class="btn btn-secondary" @onclick="CloseDelete">Ακύρωση</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Product> products;

    private string search = "";
    private string stockFilter = "all";

    private bool showDeleteModal;
    private string deleteId;
    private string deleteName;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsLoggedIn)
        {
            Navigation.NavigateTo("/admin");
            return;
        }

        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        products = await ProductService.GetAsync();
    }

    private IEnumerable<Product> FilteredProducts
    {
        get
        {
            if (products == null) return Enumerable.Empty<Product>();

            IEnumerable<Product> query = products;

            var s = (search ?? "").Trim().ToLowerInvariant();
            if (!string.IsNullOrEmpty(s))
            {
                query = query.Where(p =>
                    (p.Name ?? "").ToLowerInvariant().Contains(s) ||
                    (p.Category ?? "").ToLowerInvariant().Contains(s));
            }

            if (stockFilter == "instock")
                query = query.Where(p => p.Stock > 0);
            else if (stockFilter == "out")
                query = query.Where(p => p.Stock <= 0);

            return query.OrderBy(p => p.Name);
        }
    }

    private int TotalProducts => products?.Count ?? 0;
    private int InStockCount => products?.Count(p => p.Stock > 0) ?? 0;
    private int OutOfStockCount => products?.Count(p => p.Stock <= 0) ?? 0;

    private void GoToAdd() => Navigation.NavigateTo("/admin/products/new");
    private void GoToEdit(string id) => Navigation.NavigateTo($"/admin/products/edit/{id}");

    private async Task Refresh()
    {
        await LoadProducts();
    }

    private void AskDelete(string id, string name)
    {
        deleteId = id;
        deleteName = name;
        showDeleteModal = true;
    }

    private void CloseDelete()
    {
        showDeleteModal = false;
        deleteId = null;
        deleteName = null;
    }

    private async Task ConfirmDelete()
    {
        if (!string.IsNullOrWhiteSpace(deleteId))
        {
            await ProductService.DeleteAsync(deleteId);
            await LoadProducts();
        }
        CloseDelete();
    }
}
